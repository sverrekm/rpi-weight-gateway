<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RPI Weight Gateway</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <header>
    <div class="brand">
      <h1>RPI Weight Gateway</h1>
      <span class="badge" id="version">v-</span>
    </div>
    <div class="statusbar">
      <span class="chip" id="uptime">Uptime: -</span>
      <span class="chip" id="wifi">WiFi: -</span>
      <span class="chip" id="mqtt">MQTT: -</span>
      <span class="chip" id="ws">WS: -</span>
    </div>
  </header>

  <main>
    <section class="panel">
      <div class="panel-head">
        <h2>Live Reading</h2>
        <span class="muted" id="lastTs">—</span>
      </div>
      <div class="reading">
        <div class="value"><span id="grams">--.-</span> g</div>
        <div class="stable" id="stable">unstable</div>
      </div>
      <div class="actions">
        <button class="primary" id="btnTare">Tare</button>
        <button id="btnZero">Zero</button>
      </div>
      <div class="calibrate">
        <input type="number" id="knownGrams" placeholder="Known weight (g)" step="0.1" min="0" />
        <button id="btnCalibrate">Calibrate</button>
        <span id="calibStatus"></span>
      </div>
    </section>

  <section class="panel">
    <div class="panel-head">
      <h2>Display</h2>
      <span class="muted">Test serial display output</span>
    </div>
    <div class="grid">
      <label style="grid-column:1/-1">Send Text
        <input id="dispText" placeholder="Hello" />
      </label>
      <label>Send Grams
        <input id="dispGrams" type="number" step="0.01" placeholder="123.45" />
      </label>
    </div>
    <div class="actions">
      <button id="btnDispSendText" type="button">Send Text</button>
      <button id="btnDispSendGrams" type="button">Send Grams</button>
      <span id="dispMsg"></span>
    </div>
    <p class="hint">Ensure Display is enabled and serial parameters are correct, then use Test to verify output.</p>
  </section>

    <section class="panel">
      <div class="panel-head">
        <h2>Configuration</h2>
        <span class="muted">Save applies immediately</span>
      </div>
      <form id="cfgForm">
        <div class="grid">
          <h3 style="grid-column:1/-1;margin:8px 0 0;">Basic</h3>
          <label>GPIO DOUT
            <input name="gpio_dout" type="number" />
            <small class="hint">Pi2 Click Socket 1 → 6</small>
          </label>
          <label>GPIO SCK
            <input name="gpio_sck" type="number" />
            <small class="hint">Pi2 Click Socket 1 → 11</small>
          </label>
          <label style="width:100%">GPIO Presets
            <select id="gpioPresets">
              <option value="">Select preset…</option>
              <option value='{"gpio_dout":6,"gpio_sck":11}'>Pi2 Click Socket 1 (DOUT 6, SCK 11)</option>
              <option value='{"gpio_dout":26,"gpio_sck":11}'>Pi2 Click Socket 2 (DOUT 26, SCK 11)</option>
              <option value='{"gpio_dout":6,"gpio_sck":11}'>Default (DOUT 6, SCK 11)</option>
              <option value='{"gpio_dout":23,"gpio_sck":24}'>Alt A (DOUT 23, SCK 24)</option>
              <option value='{"gpio_dout":20,"gpio_sck":21}'>Alt B (DOUT 20, SCK 21)</option>
              <option value='{"gpio_dout":9,"gpio_sck":11}'>Alt C (DOUT 9, SCK 11)</option>
            </select>
          </label>
          <label>Demo mode
            <input name="demo_mode" type="checkbox" />
            <small class="hint">Use to verify UI without sensor</small>
          </label>

          <details style="grid-column:1/-1;">
            <summary>Advanced settings</summary>
            <div class="grid" style="margin-top:8px;">
              <label>Sample rate (Hz) <input name="sample_rate" type="number" min="1" max="80" /></label>
              <label>Median window <input name="median_window" type="number" min="1" /></label>
              <label>Scale <input name="scale" type="number" step="0.0001" /></label>
              <label>Offset <input name="offset" type="number" step="0.0001" /></label>
            </div>
          </details>

          <details style="grid-column:1/-1;">
            <summary>MQTT</summary>
            <div class="grid" style="margin-top:8px;">
              <label>MQTT Host <input name="mqtt_host" /></label>
              <label>MQTT Port <input name="mqtt_port" type="number" min="1" max="65535" /></label>
              <label>MQTT User <input name="mqtt_user" /></label>
              <label>MQTT Pass <input name="mqtt_pass" type="password" /></label>
              <label>Weight Topic <input name="weight_topic" /></label>
              <label>Status Topic <input name="status_topic" /></label>
              <label>Cmd Topic <input name="cmd_topic" /></label>
            </div>
          </details>

          <details style="grid-column:1/-1;">
            <summary>Display (ND5052)</summary>
            <div class="grid" style="margin-top:8px;">
              <label>Enable Display
                <input name="display_enabled" type="checkbox" />
                <small class="hint">Send stable readings to serial display</small>
              </label>
              <label style="grid-column:1/-1">Serial Port
                <div style="display:flex; gap:8px; align-items:center;">
                  <input name="serial_port" id="serialPortInput" list="serialPorts" placeholder="/dev/ttyUSB0" style="flex:1 1 auto" />
                  <datalist id="serialPorts"></datalist>
                  <button type="button" id="btnScanPorts">Scan</button>
                </div>
                <small class="hint">Type path or choose from suggestions after Scan.</small>
              </label>
              <label>Baudrate <input name="baudrate" type="number" min="1200" step="100" /></label>
              <label>Data bits <input name="databits" type="number" min="7" max="8" /></label>
              <label>Parity
                <select name="parity">
                  <option value="E">Even</option>
                  <option value="N">None</option>
                  <option value="O">Odd</option>
                </select>
              </label>
              <label>Stop bits <input name="stopbits" type="number" min="1" max="2" /></label>
              <label>Decimals (DP) <input name="dp" type="number" min="0" max="4" /></label>
              <label>Unit <input name="unit" placeholder="kg" /></label>
              <label>Address <input name="address" placeholder="00-99 (optional)" /></label>
            </div>
          </details>
        </div>
        <div class="actions">
          <button class="primary" id="btnSave" type="button">Save</button>
          <span id="cfgStatus"></span>
        </div>
      </form>
      <p class="hint">If you don’t see readings: turn on Demo mode to validate UI, then try the Pi2 Click preset for your socket.</p>
    </section>
  </main>

  <section class="panel">
    <div class="panel-head">
      <h2>Broker</h2>
      <span class="muted">Manage Mosquitto</span>
    </div>
    <div class="grid">
      <div style="grid-column:1/-1">
        <div class="chip" id="brokerStatus">Broker: unknown</div>
      </div>
      <label style="grid-column:1/-1">mosquitto.conf
        <textarea id="brokerConf" rows="10" style="width:100%" placeholder="listener 1883 0.0.0.0\nallow_anonymous true\n..."></textarea>
      </label>
    </div>
    <div class="actions">
      <button id="btnBrokerSave" class="primary" type="button">Save Config</button>
      <button id="btnBrokerRestart" type="button">Restart</button>
      <button id="btnBrokerStart" type="button">Start</button>
      <button id="btnBrokerStop" type="button">Stop</button>
      <span id="brokerMsg"></span>
    </div>
    <p class="hint">Requires Docker access inside container for start/stop/restart. Config is stored at /data/mosquitto.conf and mounted into the MQTT service.</p>
  </section>

  <section class="panel">
    <div class="panel-head">
      <h2>System Update</h2>
      <span class="muted">Check for new version and apply</span>
    </div>
    <div class="grid">
      <label>
        <input type="checkbox" id="chkRebuild" /> Rebuild locally
        <small class="hint">Use if running from local source instead of pulling images</small>
      </label>
    </div>
    <div class="actions">
      <button id="btnUpdate" type="button">Check & Update</button>
      <span id="updateMsg"></span>
    </div>
    <pre id="updateLogs" style="max-height:220px;overflow:auto;background:#111;color:#ddd;padding:8px;border-radius:4px"></pre>
  </section>

  <footer>
    <div class="footer-inner">
      <img src="/logo.jpg" alt="Logo" class="footer-logo" />
      <span>© 2025 Sverre Kolbjørn Merødningen</span>
    </div>
  </footer>

  <script src="/app.js"></script>
</body>
</html>
