services:
  weightd:
    build:
      context: .
      dockerfile: services/weightd/Dockerfile
    container_name: weightd
    privileged: true
    restart: unless-stopped
    depends_on:
      - mqtt
    user: "0:0"
    network_mode: host
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - SYS_ADMIN
      - SYS_NICE
    devices:
      - "/dev/net/tun:/dev/net/tun"
      - "/dev/ttyACM0:/dev/ttyACM0"
      - "/dev/ttyUSB0:/dev/ttyUSB0"
    volumes:
      - /var/run/dbus:/var/run/dbus
      - /run/NetworkManager:/run/NetworkManager
      - /etc/NetworkManager:/etc/NetworkManager
      - /var/lib/NetworkManager:/var/lib/NetworkManager
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - VERSION=0.1.0
      - MQTT_HOST=${MQTT_HOST}
      - MQTT_PORT=${MQTT_PORT}
      - MQTT_USER=${MQTT_USER}
      - MQTT_PASS=${MQTT_PASS}
      - WEIGHT_TOPIC=${WEIGHT_TOPIC}
      - STATUS_TOPIC=${STATUS_TOPIC}
      - CMD_TOPIC=${CMD_TOPIC}
      - GPIO_DOUT=${GPIO_DOUT}
      - GPIO_SCK=${GPIO_SCK}
      - SAMPLE_RATE=${SAMPLE_RATE}
      - MEDIAN_WINDOW=${MEDIAN_WINDOW}
      - SCALE=${SCALE}
      - OFFSET=${OFFSET}
      - MAX_CAPACITY_G=${MAX_CAPACITY_G:-0}
      - WIFI_AP_SSID=${WIFI_AP_SSID}
      - WIFI_AP_PASS=${WIFI_AP_PASS}
      - AP_COUNTRY=${AP_COUNTRY}
      - DEMO_MODE=${DEMO_MODE}
      - DISPLAY_ENABLED=${DISPLAY_ENABLED:-false}
      - SERIAL_PORT=${SERIAL_PORT:-}
      - SERIAL_BAUD=${SERIAL_BAUD:-9600}
      - DBUS_SYSTEM_BUS_ADDRESS=unix:path=/var/run/dbus/system_bus_socket
      - SERIAL_DATABITS=${SERIAL_DATABITS:-7}
      - SERIAL_PARITY=${SERIAL_PARITY:-E}
      - SERIAL_STOPBITS=${SERIAL_STOPBITS:-1}
      - DISPLAY_DP=${DISPLAY_DP:-2}
      - DISPLAY_UNIT=${DISPLAY_UNIT:-kg}
      - DISPLAY_ADDR=${DISPLAY_ADDR:-}
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8000/api/health')"]
      interval: 15s
      timeout: 3s
      retries: 10
      start_period: 20s
    # No hard depends_on for mqtt so the service can run without broker

  mqtt:
    image: eclipse-mosquitto:2
    container_name: mqtt
    restart: unless-stopped
    volumes:
      - ./data/mosquitto.conf:/mosquitto/config/mosquitto.conf
      - ./data/mosquitto:/mosquitto/data
    network_mode: host
    healthcheck:
      test: ["CMD", "mosquitto_sub", "-h", "127.0.0.1", "-t", "$$SYS/broker/version", "-C", "1"]
      interval: 20s
      timeout: 5s
      retries: 5

  wifi-connect:
    image: balenablocks/wifi-connect:latest
    container_name: wifi-connect
    profiles: ["wifi"]
    network_mode: host
    environment:
      - PORTAL_SSID=${WIFI_AP_SSID}
      - PORTAL_PASSPHRASE=${WIFI_AP_PASS}
      - WIFI_COUNTRY=${AP_COUNTRY}
    cap_add:
      - NET_ADMIN
    restart: unless-stopped


